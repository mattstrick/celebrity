<html>
<head>
  <title>CELEBRITY</title>
</head>
<body>
  <div id="container">
    <form name="name_input" id="name_input" style="display:none;">
      <label>Type Celebrity <span>1</span>:</label>
      <input id="celebrity_name" type="text" />
    </form>

    <form name="round_start" id="round_start" style="display:none;">
      <label>Ready Round <span>1</span>:</label>
      <button type="button" id="start_button" value="Begin">Begin</button>
    </form>

    <form name="round_end" id="round_end" style="display:none;">
      <button type="button" id="end_button" value="Done">Done</button>
    </form>

    <form name="switch_teams" id="switch_teams" style="display:none;">
      <button type="button" id="switch_teams_button" value="Begin">Start Turn</button>
    </form>

    <form name="name_next" id="name_next" style="display:none;">
      <button type="button" id="name_next_button" value="Next">Next</button>
    </form>

    <section id="label">
    </section>

    <section id="timing">
    </section>

    <section id="score">
      <p class="team1">Team 1 <span>0</span></p>
      <p class="team2">Team 2 <span>0</span></p>
    </section>

    <div id="debug" style="display:none;">
      <ul id="steps">
        <li>
          Get Names
        </li>
        <li>
          Round 1
          <ul>
            <li>names used: 0</li>
            <li>names left: 0</li>
            <li>Team 1: 0</li>
            <li>Team 2: 0</li>
          </ul>
        </li>
        <li>
          Round 2
          <ul>
            <li>names used: 0</li>
            <li>names left: 0</li>
            <li>Team 1: 0</li>
            <li>Team 2: 0</li>
          </ul>
        </li>
        <li>
          Round 3
          <ul>
            <li>names used: 0</li>
            <li>names left: 0</li>
            <li>Team 1: 0</li>
            <li>Team 2: 0</li>
          </ul>
        </li>
      </ul>
      <section id="celebrities"></section>
      <section id="roundDebug"></section>
    </div>
  </div>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    (function () {
      'use strict';
      var debug, $debugElem, initialize, Game, Celebrities, Timing;

      // Initialize Variables.
      debug = (/debug/.test(window.location.search));
      $debugElem = $('#debug');


      if (debug) {
        $debugElem.show();
      }


      ///////////////////
      // Set up our Game
      ///////////////////
      Game = function (id) {
        this.state = 0;
        this.celebrities = new Celebrities();
        this.container = document.getElementById(id);
        this.label = document.getElementById('label');
        this.timer = new Timing();
        this.height = this.container.clientHeight;
        this.width = this.container.clientWidth;
        this.Score = {
          team_1 : 0,
          team_2 : 0
        };
        this.team = 1,
        this.Round = {
          num : 0,
          celebrities : new Celebrities()
        };

        this.Elements = {
          nameInput : "#name_input",
          roundStart : "#round_start",
          roundEnd : "#round_end",
          teamSwitch : "#switch_teams",
          nameNext : "#name_next"
        };

        self = this;

        // Event Handlers
        // Get the next celebrity name
        $('#celebrity_name').keypress(function (e) {
          if (e.which === 13) {
            e.preventDefault();
            $('form#name_input').submit();
            return false;
          }
        });

        // Start Round
        $('#start_button').on('click',function (e) {
          e.preventDefault();
          // Start Turn
          self.startTurn();

          return false;
        });

        // End Round
        // TODO: Is this still necessary?
        $('#end_button').on('click',function (e) {
          e.preventDefault();
          // End Turn
          self.endTurn();

          return false;
        });

        // Get Next Name for this turn
        $(this.Elements.nameNext).find('button').on('click', function (e) {
          e.preventDefault();

          self.addPoints(self.team, 1);
          if (self.Round.celebrities.getCelebritiesLength() > 0) {
            self.getNextName();
          } else {
            self.hideElem(self.Elements.nameNext);
            self.timer.cancelCountdown();

          }

          return false;
        });



        window.onkeydown = function (e) {
          var key = e.keyCode;
          if (key === 13) {
            e.preventDefault();

            if (self.state === 1) {
              self.addName();
            }
          }

        };

        this.stateUpdate(1);
      };
      
      Game.prototype = {
        stateUpdate : function (newState) {
          if (this.state === newState) {
            console.log("Can't update to the same state!");
          } else { 
            this.state = newState;
            console.log("New state: " + newState);



            switch (newState) {
              // Collect Names
              case 1 : 
                this.showElem(this.Elements.nameInput);
                break;

              // Start Round 1
              case 2 :
                this.hideElem(this.Elements.nameInput);
                //Make copy of celebs array to pass to stepThroughNames
                this.roundStart();

                break;

              // Start Round 2

              // Start Round 3
              default : 
                console.log('State: ' + newState + " doesn't exist yet.");
                break;
            }
          }

          return this.state;
        },

        nextState : function () {
          var currentState = parseInt(this.state, 10);

          if (debug) {
            var step = $('#steps li')[currentState - 1];
            var completedStep = '&#10003;' + step.innerHTML;

            step.innerHTML = completedStep;
          }

          this.stateUpdate(currentState + 1);
        },

        roundStart : function () {
          var _roundNum = this.Round.num + 1;
          var _celebrities = this.celebrities.getArray();

          this.Round.celebrities.addNameByArr(_celebrities);
          this.showElem(this.Elements.roundStart);

        },

        startTurn : function () {
          this.hideElem(this.Elements.roundStart);
          this.showElem(this.Elements.nameNext);
          
          this.timer.countdown(30);
          this.getNextName();
          // TODO: Get name and display it
        },

        endTurn : function () {
          console.log('hi!');
          // TODO: calculate points
          // hide End Button
          // show Start Button
        },

        getNextName : function () {
          var _name;
          _name = this.Round.celebrities.removeByIndex(this.Round.celebrities.returnRandomIndex()); 
          
          console.log (_name);
          return _name;
        },

        addPoints : function (team, points) {
          console.log("adding " + points + " to team: " + team);
          if (team === 1) {
            this.Score.team_1 += points;
          } else {
            this.Score.team_2 += points;
          }
          return this.scoreUpdate();
        },

        scoreUpdate : function () { 
          $('.team1').find('span').html(this.Score.team_1);
          $('.team2').find('span').html(this.Score.team_2);
        },

        teamSwitch : function () {
          return (this.team === 1)? this.team = 2 : this.team = 1;
        },

        hideElem : function (selector) {
          return $(selector).hide();
        },

        showElem : function (selector) {
          return $(selector).show();
        },

        incrementLabel : function () {
          console.log(this.celebrities.getCelebritiesLength());
          return $('form#name_input span').html(this.celebrities.getCelebritiesLength() + 1);
        },

        startRound : function () {
          var round = this.Round.num + 1;

          this.showRoundButton();
        },

        // Takes a celebs obj, removes one, and starts timer
        stepThroughNames : function () {
          var _celebs = new Celebrities();
          _celebs.addNameByArr(this.celebrities.returnArr());

          console.log('New celebrities array ' + _celebs.returnArr());

          var _name = "";

          //While there are names in the array
          while (_celebs.getCelebritiesLength() > 0) {
            //Pick a name
            _name = _celebs.removeByIndex(_celebs.returnRandomIndex());
            //Display It
            this.label.innerHTML = _name;
            console.log(_name);
          }

          //Countdown
          console.log('hey');
        },

        addName : function() {
          var $input = $('input');
          var name = $input.val();
          console.log(name);

          if (name.trim() === "") {
            return console.log("Input was empty!");
          }

          if (!this.celebrities.isFull()){
            this.celebrities.addName(name);
            this.incrementLabel();
          } else {
            this.nextState();

            console.log(this.celebrities.getArray());
          }

          // Reset Input Field
          $input.val("");

          return;
        }
      };


      ///////////////////
      // Set up our Celebrity Names
      ///////////////////
      Celebrities = function () {
        this.celebrityArr = [];
        this.maxSize = 9;
      };

      Celebrities.prototype = {
        returnRandomIndex : function () {
          var randIndex;

          if (this.celebrityArr.length === 0) {
            return false;
          }

          if (this.celebrityArr.length === 1) {
            return 0;
          }
          
          randIndex = Math.floor(Math.random() * this.celebrityArr.length);
          console.log(randIndex);
          
          return randIndex;
        },

        getCelebritiesLength : function () {
          return this.celebrityArr.length;
        },

        getArray : function () {
          return this.celebrityArr;
        },

        addName : function (name) {
          this.celebrityArr.push(name);
          
          if (debug) {
            $debugElem.find('#celebrities').html(this.celebrityArr.toString());
          }
          
          return true;
        },

        addNameByArr : function (arr) {
          this.celebrityArr = arr;
        },

        removeByIndex : function (index) {
          return this.celebrityArr.splice(index,1);
        },

        returnArr : function () {
          return this.celebrityArr;
        },

        isFull : function () {
          return (this.celebrityArr.length === this.maxSize)? true : false;
        }
      };

      Timing = window.Timing = function () {
        this.requestId = undefined;
      };

      Timing.prototype = {
        countdown : function (repeats) {
          var start = null;
          var timingElem = document.getElementById('timing');
          var self = this;

          var step = function (timestamp) {
            if (!start) start = timestamp;
            var _progress = timestamp - start;
            var _seconds = parseInt(Math.min(_progress/1000), 10);
            
            //Timestamp
            //console.log(timestamp);
            //Timing
            //console.log(_progress);
            //Timing (sec)
            //console.log(_seconds);
            
            //Countdown
            timingElem.innerHTML = repeats - _seconds;

            if (_progress < (repeats * 1000)) {
              self.requestId = window.requestAnimationFrame(step);
            }
            // Fire when done.
            if (_seconds == repeats) {
              console.log("done!");
              self.requestId = undefined;
              return true;
            }
          }

          self.requestId = window.requestAnimationFrame(step);

        },

        isAnimating : function () {
          if (!this.requestId) {
            console.log("not running.");
            return false;
          } else {
            console.log('running');
            return true;
          }
        },

        cancelCountdown : function () {
          return window.cancelAnimationFrame(this.requestId);
        }
      };

      // Functions
      window.onload = function () {
        new Game('container');
      };

    })();
  </script>
</body>
</html>