<html>
<head>
  <title>CELEBRITY</title>
</head>
<body>
  <div id="container">
    <form name="name_input" id="name_input" style="display:none;">
      <label>Type Celebrity <span>1</span>:</label>
      <input id="celebrity_name" type="text" />
    </form>

    <form name="round_start" id="round_start" style="display:none;">
      <label>Ready Round <span>1</span>:</label>
      <button type="button" id="start_button" value="Begin">Begin</button>
    </form>

    <form name="round_end" id="round_end" style="display:none;">
      <button type="button" id="end_button" value="Done">Done</button>
    </form>

    <section id="label">
    </section>

    <section id="timing">
    </section>

    <div id="debug" style="display:none;">
      <ul id="steps">
        <li>
          Get Names
        </li>
        <li>
          Round 1
        </li>
        <li>
          Round 2
        </li>
        <li>
          Round 3
        </li>
      </ul>
      <section id="celebrities"></section>
      <section id="roundDebug"></section>
    </div>
  </div>
  <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    (function () {
      'use strict';
      var debug, $debugElem, initialize, Game, Celebrities, Timing;

      // Initialize Variables.
      debug = (/debug/.test(window.location.search));
      $debugElem = $('#debug');


      if (debug) {
        $debugElem.show();
      }


      ///////////////////
      // Set up our Game
      ///////////////////
      Game = function (id) {
        this.state = 0;
        this.celebrities = new Celebrities();
        this.container = document.getElementById(id);
        this.label = document.getElementById('label');
        this.timer = new Timing();
        this.height = this.container.clientHeight;
        this.width = this.container.clientWidth;
        this.Score = {
          team_1 : 0,
          team_2 : 0
        };
        this.Round = {
          num : 0,
          celebrities : new Celebrities(),
          Score : {
            team_1 : 0,
            team_2 : 0
          },
        };

        self = this;

        // Event Handlers
        $('#celebrity_name').keypress(function (e) {
          if (e.which === 13) {
            e.preventDefault();
            $('form#name_input').submit();
            return false;
          }
        });

        $('#start_button').on('click',function (e) {
          e.preventDefault();
          // Start Turn
          self.startTurn();

          return false;
        });

        $('#end_button').on('click',function (e) {
          e.preventDefault();
          // End Turn
          self.endTurn();

          return false;
        });



        window.onkeydown = function (e) {
          var key = e.keyCode;
          if (key === 13) {
            e.preventDefault();

            if (self.state === 1) {
              self.addName();
            }
          }

        };

        this.stateUpdate(1);
      };
      
      Game.prototype = {
        stateUpdate : function (newState) {
          if (this.state === newState) {
            console.log("Can't update to the same state!");
          } else { 
            this.state = newState;
            console.log("New state: " + newState);



            switch (newState) {
              // Collect Names
              case 1 : 
                this.showCelebrityInput();
                this.stepThroughNames();
                break;

              // Start Round 1
              case 2 :
                this.hideCelebrityInput();
                //Make copy of celebs array to pass to stepThroughNames
                this.roundStart();

                break;

              // Start Round 2

              // Start Round 3
              default : 
                console.log('State: ' + newState + " doesn't exist yet.");
                break;
            }
          }

          return this.state;
        },

        nextState : function () {
          var currentState = parseInt(this.state, 10);

          if (debug) {
            var step = $('#steps li')[currentState - 1];
            var completedStep = '&#10003;' + step.innerHTML;

            step.innerHTML = completedStep;
          }

          this.stateUpdate(currentState + 1);
        },

        roundStart : function () {
          var _roundNum = this.Round.num + 1;
          var _celebrities = this.celebrities.getArray();

          this.Round.Score.team_1 = 0;
          this.Round.Score.team_2 = 0;

          this.Round.celebrities.addNameByArr(_celebrities);
          this.showRoundStartButton();
        },

        startTurn : function () {
          this.hideRoundStartButton();
          this.showRoundEndButton();
          console.log('hi!');
        },

        endTurn : function () {

        },

        showCelebrityInput : function () {
          return $("#name_input").show();
        },

        hideCelebrityInput : function () {
          return $("#name_input").hide();
        },

        showRoundStartButton : function () {
          return $("#round_start").show();
        },

        hideRoundStartButton : function () {
          return $("#round_start").hide();
        },

        showRoundEndButton : function () {
          return $("#round_end").show();
        },

        hideRoundEndButton : function () {
          return $("#round_end").hide();
        },

        incrementLabel : function () {
          console.log(this.celebrities.getCelebritiesLength());
          return $('form#name_input span').html(this.celebrities.getCelebritiesLength() + 1);
        },

        startRound : function () {
          var round = this.Round.num + 1;

          this.showRoundButton();
        },

        // Takes a celebs obj, removes one, and starts timer
        stepThroughNames : function () {
          var _celebs = new Celebrities();
          _celebs.addNameByArr(this.celebrities.returnArr());

          console.log('New celebrities array ' + _celebs.returnArr());

          var _name = "";

          //While there are names in the array
          while (_celebs.getCelebritiesLength() > 0) {
            //Pick a name
            _name = _celebs.removeByIndex(_celebs.returnRandomIndex());
            //Display It
            this.label.innerHTML = _name;
            console.log(_name);
          }

          //Countdown
          console.log('hey');
        },

        addName : function() {
          var $input = $('input');
          var name = $input.val();
          console.log(name);

          if (name.trim() === "") {
            return console.log("Input was empty!");
          }

          if (!this.celebrities.isFull()){
            this.celebrities.addName(name);
            this.incrementLabel();
          } else {
            this.nextState();

            console.log(this.celebrities.getArray());
          }

          // Reset Input Field
          $input.val("");

          return;
        }
      };


      ///////////////////
      // Set up our Celebrity Names
      ///////////////////
      Celebrities = function () {
        this.celebrityArr = [];
        this.maxSize = 9;
      };

      Celebrities.prototype = {
        returnRandomIndex : function () {
          var randIndex;

          if (this.celebrityArr.length === 0) {
            return false;
          }

          if (this.celebrityArr.length === 1) {
            return 0;
          }
          
          randIndex = Math.floor(Math.random() * this.celebrityArr.length);
          console.log(randIndex);
          
          return randIndex;
        },

        getCelebritiesLength : function () {
          return this.celebrityArr.length;
        },

        getArray : function () {
          return this.celebrityArr;
        },

        addName : function (name) {
          this.celebrityArr.push(name);
          
          if (debug) {
            $debugElem.find('#celebrities').html(this.celebrityArr.toString());
          }
          
          return true;
        },

        addNameByArr : function (arr) {
          this.celebrityArr = arr;
        },

        removeByIndex : function (index) {
          return this.celebrityArr.splice(index,1);
        },

        returnArr : function () {
          return this.celebrityArr;
        },

        isFull : function () {
          return (this.celebrityArr.length === this.maxSize)? true : false;
        }
      };

      Timing = window.Timing = function () {
        this.repeats = 0;
        this.requestId = undefined;
      };

      Timing.prototype = {
        countdown : function (repeats) {
          var start = null;
          var timingElem = document.getElementById('timing');
          var self = this;

          var step = function (timestamp) {
            if (!start) start = timestamp;
            var progress = timestamp - start;

            //Timestamp
            //console.log(timestamp);
            //Timing
            //console.log(progress);
            //Timing (sec)
            //console.log(parseInt(Math.min(progress/1000, 10)));
            
            //Countdown
            timingElem.innerHTML = repeats - parseInt(Math.min(progress/1000, 10));
            if (progress < (repeats * 1000)) {
              self.requestId = window.requestAnimationFrame(step);
            }
            // Fire when done.
            if (parseInt(Math.min(progress/1000, 10)) == repeats) {
              console.log("done!");
              self.requestId = undefined;
              return true;
            }
          }

          self.requestId = window.requestAnimationFrame(step);

        },

        isAnimating : function () {
          if (!this.requestId) {
            console.log("not running.");
            return false;
          } else {
            console.log('running');
            return true;
          }
        }
      };

      // Functions
      window.onload = function () {
        new Game('container');
      };

    })();
  </script>
</body>
</html>